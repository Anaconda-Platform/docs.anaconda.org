{% from "macros.html" import section with context %}

{% section %}
{{page_header(self, resource, 'Overview')}}

The **Anaconda Build System** provides **Continuous Integration** powered by **conda** and **conda environments** for all platforms, through a simple yet powerful interface.

The build process follows an **Anaconda Build Recipe** (a set of instructions specified in a `.binstar.yml` or `.anaconda.yml` file), which includes the (conda) test enviornments to use, build instructions and additional scripts to be executed. A **Build Recipe** does not require the creation of a **conda package** as a final product. However, creating **conda packages** and uploading them to Anaconda Cloud provides a seamless and comprehensive workflow for the maintenance and distribution of packages.

<div class="alert alert-info">
<strong>Note:</strong> We can add something regarding suggested/recommended workflows?
</div>


{{resource.add_subindex('Why use Anaconda Build?')}}

### Why use the Anaconda Build?

There are several use cases for which Anaconda Build can be used to provide an efficient packaging workflow. A user may:

- Have a series of packages and want to compile them into conda packages so it's easy for other users to conda install those packages from the first user's channel on Anaconda Cloud.

- Be part of a workgroup or team using a GitHub repository that has basic Continuous Integration needs that can be centralized with Anaconda Cloud so other potential users can easily download their open source packages for different platforms.

- Be part of an organization that needs to build and distribute cross-platform conda packages across OS X, Windows and Linux.


{{resource.add_subindex('System Components')}}
### System Components
The **Anaconda Cloud Build System** is based on three main components:
<br>
<br>
#### Build Queues

The **Build Queues** receive build job requests from users and assign these requests to the different available workers. Queues are hosted on **Anaconda Cloud**.

Each Anaconda Cloud user may use the public Linux-64 build queue provided by Anaconda Cloud. New build queues can be created by organizations on Anaconda Cloud.

When an organization creates a queue no groups have access to it, and the organization can grant access to that queue to one or more groups. The organization can create groups, add organizations and individual users to a group or remove them, and can turn on or off a group's access to a queue.


#### Workers

These are machines that perform the actual build instructions and testing specified in the **Anaconda Build Recipe**. They are often Amazon Web Services (AWS) instances. Different workers can be created for different platforms including: 

- Windows 32/64
- Linux 32/64
- OS X 64

<div class="alert alert-info">
<strong>Note:</strong> by default only Linux-64 build workers are available for public use with Anaconda Cloud. For access to additional platforms you can add your own build workers on your local machine, in virtual machines (VMs) or on cloud computing providers such as AWS.
</div>


#### Users

Users are responsible for creating and launching anaconda builds from the command line interface into a (previously created) build queue.

To enable a user to use a queue other than the Anaconda Cloud public Linux-64 queue, the organization that created the queue must add the user to a group and grant that group access to the queue.

{% endsection %}


{% section %}
{{page_header(self, resource, 'Builds in Anaconda.org')}}
{% endsection %}

{% section %}
{{resource.add_subindex('Prerequisites')}}
### Prerequisites

In order to get started with the Anaconda Build System you must first:

1. Create an account on Anaconda Cloud at <a href="https://anaconda.org/">anaconda.org</a>
2. Install Anaconda or <a href="http://conda.pydata.org/miniconda.html">Miniconda</a>
3. Install Anaconda Client and Anaconda Build: `conda install anaconda-client anaconda-build`
4. Log in to Anaconda Cloud from the command line using Anaconda Client: `anaconda login`
5. (**Optional**) Create an organization to be able to create new queues, at <a href="https://anaconda.org/new/organization">anaconda.org/new/organization</a>
6. Start building!

{% endsection %}


{% section %}
{{resource.add_subindex('Submit your first build')}}
### Submit your first build
{% endsection %}

{% section %}
#### Create a package
{% endsection %}
{% section %}

If you are not familiar with anaconda-client, create a package first.
This will be the namespace or the context of the build.

{% example %}

    mkdir conda_build_test
    cd conda_build_test
    anaconda package --create #userdefined{USERNAME}/conda_build_test

{% endsection %}


{% section %}

#### Create a build config
{% endsection %}
{% section %}

Let's create a simple build config file and submit an empty build job to illustrate the basic steps. 

The `.binstar.yml` or `.anaconda.yml` file holds the Anaconda Build Recipe for how to build and test your package. It tells the build system which platforms to build on, which environment variables to use and which scripts to execute.

To add a `.binstar.yml` file to your working directory, run `anaconda build init` in your
working directory.


<div class="alert alert-info">
 <strong>Note:</strong> This should be the same directory as your `meta.yaml` file if you are building a conda package.
</div>

Once this is complete you should be able to submit your first
build that will print `This is my anaconda build!`

We have just created an empty package with a single Build Recipe instruction, namely printing `This is my anaconda build!`.


{% example %}

    anaconda build init
    anaconda build submit .
    anaconda build tail -f #userdefined{USERNAME}/conda_build_test #userdefined{1}

{% endsection %}

{% section %}
#### Create conda package
{% endsection %}
{% section %}

Let's create a conda package to show that anaconda build can do some actual work.

You need to add a `meta.yaml` file and modify your `.binstar.yml` file so it contains the following keys:

<div class="alert alert-info">
<strong>Note:</strong> Please see our publicly available <a href="https://github.com/conda/conda-recipes">Conda Recipes</a>.
</div>

{% example %}
<div class="file">
<span class="title">.binstar.yml</span>
{% syntax yaml %}
package: conda_build_test
script:
  - conda build .
build_targets: conda
{% endsyntax %}
</div>

<div class="file">
<span class="title">meta.yaml</span>
{% syntax yaml %}
package:
  name: conda_build_test
  version: 0.0.1
build:
  number: 1
  script:
    - echo "This is my anaconda build with conda"
requirements:
  run:
    - python
about:
  summary: This is an anaconda build test!
{% endsyntax %}
</div>

{% endsection %}


{% section %}
#### Submit your conda build
{% endsection %}
{% section %}

Once your have created the `meta.yaml` file you can test that your conda
build runs locally with [conda build](http://conda.pydata.org/docs/build.html)

Submitting this build is the same as the first:

{% example %}

    conda build .
    anaconda build submit .
    anaconda build tail -f #userdefined{USERNAME}/conda_build_test #userdefined{2}

{% endsection %}

{% section %}
#### Install your new conda package
{% endsection %}
{% section %}
By default anaconda.org puts all new packages in a `dev` channel in your account.
See [using channels for testing and production](#UsingChannelsForTestingAndProduction)
for a more in depth example on how to use channels.

{% example %}

    conda install -c #userdefined{USERNAME}/channel/dev conda_build_test

{% endsection %}


{% section %}
{{resource.add_subindex('Submit a build from github')}}
### Submit a build from github
{% endsection %}

{% section %}
#### Create a git repo

Let's use the package you have created in the [submit your first build](#SubmitYourFirstBuild) example.
First [create a new github repository](https://github.com/new).
You will then need to push the files to github.

{% example %}
First:
<a class="btn btn-xs btn-success" href="https://github.com/new">create a new github repository</a>

	git init
	git add * .binstar.yml
	git commit -m "first commit"
	git remote add origin https://github.com/#userdefined{GITHUB_USERNAME}/conda_build_test.git
	git push -u origin master

{% endsection %}

{% section %}
#### Submit the build

Once the package source is pushed to github you can submit a build via a github url.

{% example %}

    anaconda build submit https://github.com/#userdefined{GITHUB_USERNAME}/conda_build_test

{% endsection %}


{% section %}
{{resource.add_subindex('Save and Trigger Your Builds')}}
### Save and Trigger Your Builds
{% endsection %}
{% section %}

Once you have [submitted a build from github](#SubmitABuildFromGithub)
you may want to save your build configuration. Especially if you are using
[extra options]({{content_url('cli.html')}}#Submit)
like `-p`, `--sub-dir`, `--channel`, `--queue` or `--email`

You can [save]({{content_url('cli.html')}}#Save) these options to anaconda.org
and [trigger]({{content_url('cli.html')}}#Trigger) them later.

<div class="alert alert-info">
<strong>Note:</strong> Using the anaconda build save command affects the Continuous Integration (CI) section of the package settings on Anaconda Cloud. For example, running an "anaconda build save" command that uses the "--channel" flag will update the channel used by CI services. The CI section of the package settings can be seen by going to the package's page on Anaconda Cloud and choosing "Settings" and then "Continuous Integration", or by examining the package's binstar.yaml file.
</div>

{% example %}

	anaconda build save -p #userdefined{USERNAME}/conda_build_test https://github.com/#userdefined{GITHUB_USERNAME}/conda_build_test --channel dev
	anaconda build trigger #userdefined{USERNAME}/conda_build_test

{% endsection %}

{% section %}
{{resource.add_subindex('Continuous Integration: run a build on git push')}}
### Continuous Integration: run a build on git push
{% endsection %}

{% section %}

Once you have saved a build you can view the information on the web-site at

`https://anaconda.org/#userdefined{USERNAME}/conda_build_test/settings/ci`

To get to this page, navigate to your package `https://anaconda.org/#userdefined{USERNAME}/conda_build_test`
Then click on the `settings` tab near the top right then click on the `Continuous Integration` tab
near the middle left.

{% example %}


![Continuous Integration page]({{media_url('img/ci.png')}})


{% endsection %}

{% section %}

Click "Edit". The fields we care about for enabling continuous integration are:


<dl class="dl-horizontal">
<dt>branches to test<dt>
<dd> This is a python regex describing what branches should trigger builds in `test-only` mode.
No files will be uploaded to anaconda.org.
<dd>
<dt>branches to upload<dt>
<dd>
    This is a python regex describing what branches should trigger builds that also upload the
    resulting
    <a href="{{content_url('build-config.html')}}#Build_Targets">build_targets</a>.
    <div class="alert alert-warning">
    <i class="glyphicon glyphicon-exclamation-sign"></i>
    This can cause a lot of files to accumulate in your account, use carefully.
    </div>
<dd>
<dt>Add Webhook<dt>
<dd>If checked anaconda.org will add a
  <a href="https://developer.github.com/webhooks/">github webhook</a> with the value
  <a href="https://api.anaconda.org/github-hook">https://api.anaconda.org/github-hook</a>
  to your github package.
<dd>
</dl>
{% endsection %}

{% section %}

For the purpose of this example:

  * Set `Test Branches` to `refs/heads/.*`, this will match all git branches
  * Leave `Upload Branches` empty
  * Ensure that `Add Webhook` is checked

You should see an active webhook at the end of this process.

{% example %}

![Continuous Integration page]({{media_url('img/webhook-ci.png')}})

{% endsection %}
{% section %}

Now, test that the web hook is correct by pushing an empty commit.

To debug webhooks, first submit your build again with [anaconda-client trigger](#SaveAndTriggerYourBuilds)
This should highlight the issue with your build.

If `anaconda trigger` works, but the webhook still does not, 
go to github and inspect the webhook requests and responses.

{% example %}

{% syntax bash %}
git commit -m "Trigger build" --allow-empty
git push

# This should give enough time to let github send the webhook
sleep 10

anaconda build list-all ~userdefined:USERNAME:/conda_build_test
{% endsyntax %}


{% endsection %}


{% section %}
{{page_header(self, resource, 'Advanced Build Topics')}}

For more information on advanced configuration for the Anaconda Build recipe,
and the creation of your own workers, please visit the <a href="/build-config.html">Build Reference</a>.
{% endsection %}
